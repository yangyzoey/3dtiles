<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Use correct character set. -->
    <meta charset="utf-8" />
    <!-- Tell IE to use the latest, best version. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <title>Hello World!</title>
    <script src="/Cesium-1.110/Build/CesiumUnminified/Cesium.js"></script>
    <style>
      @import url(/Cesium-1.110/Apps/Sandcastle/templates/bucket.css);
    </style>
  </head>
  <body>
    <div id="cesiumContainer" class="fullSize"></div>
    <div id="loadingOverlay"><h1>Loading...</h1></div>
    <div id="toolbar">
      <select data-bind="options: tilesets, optionsText: 'name', value: selectedTileset, optionsCaption: 'Choose a Tileset...'"></select>
      <div><input type="checkbox" data-bind="checked: shadows"> Shadows</div>
    </div>
    <script>


      const viewer = new Cesium.Viewer("cesiumContainer", {
  shadows: false,
});
viewer.extend(Cesium.viewerCesium3DTilesInspectorMixin);
const inspectorViewModel = viewer.cesium3DTilesInspector.viewModel;

viewer.clock.currentTime = new Cesium.JulianDate(2457522.154792);

const scene = viewer.scene;
let tileset;

const viewModel = {
  tilesets: [
    {
      name: "Tileset",
      resource:
      '/tiles/tileset.json',
    },
  ],
  selectedTileset: undefined,
  shadows: true,
};

/*
//加载地图
//获取默认情况下图层数组容器，默认length=1 或者 viewer.scene.imageryLayers
var layers = viewer.imageryLayers._layers;

//将第一个影像图层设置为隐藏 下标0
viewer.scene.imageryLayers.get(0).show = true; //false;

//隐藏了唯一的一个影像图层，地球变成一个蓝色的圆球
//可以通过下面的命令将无图层服务的蓝色圆球变成WHITE or BLACK
//viewer.scene.globe.baseColor = Cesium.Color.BLACK;
*/


Cesium.knockout.track(viewModel);

const toolbar = document.getElementById("toolbar");
Cesium.knockout.applyBindings(viewModel, toolbar);

Cesium.knockout
  .getObservable(viewModel, "shadows")
  .subscribe(function (enabled) {
    viewer.shadows = enabled;
  });

let resourceToLoad;
Cesium.knockout
  .getObservable(viewModel, "selectedTileset")
  .subscribe(async function (options) {
    if (Cesium.defined(tileset)) {
      scene.primitives.remove(tileset);
    }
    if (!Cesium.defined(options)) {
      inspectorViewModel.tileset = undefined;
      resourceToLoad = undefined;
      return;
    }

    resourceToLoad = options.resource;
    try {
      tileset = await Cesium.Cesium3DTileset.fromUrl(resourceToLoad, {
        enableDebugWireframe: true,
      });
      if (options.resource !== resourceToLoad) {
        // Another tileset was loaded. Discard the result.
        return;
      }
  

      viewer.scene.primitives.add(tileset);

/*
//设置数据位置和方向
//根据经纬度生成transform
//给到数据的root.transform

    tileset.readyPromise.then(function(){
    var longitude = 2.254825261091031;
    var latitude = 0.6138864903996801;
    var height = 0.0;
    var cartesian = Cesium.Cartesian3.fromDegrees(longitude, latitude, height);
    var transform = Cesium.Transforms.eastNorthUpToFixedFrame(cartesian);
    
    tileset._root.transform = transform; //根节点变换矩阵 //Cesium.Matrix4.IDENTITY;
    //tileset.modelMatrix = transform; 
});
*/

        //the camera's heading, pitch, and range
      inspectorViewModel.tileset = tileset;
      viewer.zoomTo(
        tileset,
        new Cesium.HeadingPitchRange(
          0,
          -2.0,
          Math.max(100.0 - tileset.boundingSphere.radius, 0.0)
        )
      );

      ///*
      const properties = tileset.properties;
      if (
        Cesium.defined(properties) &&
        Cesium.defined(properties.Height)
      ) {
        tileset.style = new Cesium.Cesium3DTileStyle({
          color: {
            conditions: [
              ["${Height} >= 83", "color('purple', 0.5)"],
              ["${Height} >= 80", "color('red')"],
              ["${Height} >= 70", "color('orange')"],
              ["${Height} >= 12", "color('yellow')"],
              ["${Height} >= 7", "color('lime')"],
              ["${Height} >= 1", "color('cyan')"],
              ["true", "color('blue')"],
            ],
          },
        });
      }
      //*/



    } catch (error) {
      console.log(`Error loading tileset: ${error}`);
    }


  });

viewModel.selectedTileset = viewModel.tilesets[0];

const handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);

handler.setInputAction(function (movement) {
  const feature = inspectorViewModel.feature;
  if (Cesium.defined(feature)) {
    const propertyIds = feature.getPropertyIds();
    const length = propertyIds.length;
    for (let i = 0; i < length; ++i) {
      const propertyId = propertyIds[i];
      console.log(`${propertyId}: ${feature.getProperty(propertyId)}`);
    }
  }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);

handler.setInputAction(function (movement) {
  const feature = inspectorViewModel.feature;
  if (Cesium.defined(feature)) {
    feature.show = false;
  }
}, Cesium.ScreenSpaceEventType.MIDDLE_CLICK);

    </script>
  </body>
</html>